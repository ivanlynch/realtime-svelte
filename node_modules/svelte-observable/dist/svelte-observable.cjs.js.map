{"version":3,"file":"svelte-observable.cjs.js","sources":["../src/utils.ts","../src/observe.ts","../src/flat.ts"],"sourcesContent":["import { Observable, Deferred, Fulfill, Reject } from './types';\n\nlet OBSERVABLE: symbol | string | undefined;\n\nexport function isObservable(value: any): value is Observable<any> {\n  // Lazy-load Symbol to give polyfills a chance to run\n  if (!OBSERVABLE) {\n    OBSERVABLE =\n      (typeof Symbol === 'function' && Symbol.observable) || '@@observable';\n  }\n\n  return value && value[OBSERVABLE] && value[OBSERVABLE]() === value;\n}\n\nexport interface Resolve<T> {\n  fulfill: Fulfill<T>;\n  reject: Reject;\n}\n\nexport function deferred<T>(\n  set: (value: Deferred<T>) => void,\n  initial?: T\n): Resolve<T> {\n  let initialized = initial !== undefined;\n  let resolve: (value: T) => void | undefined;\n  let reject: (error: Error) => void | undefined;\n\n  // Set initial value\n  set(\n    initialized\n      ? initial!\n      : new Promise<T>((_resolve, _reject) => {\n          resolve = _resolve;\n          reject = _reject;\n        })\n  );\n\n  return {\n    fulfill(value) {\n      if (initialized) return set(Promise.resolve(value));\n\n      initialized = true;\n      resolve(value);\n    },\n    reject(error) {\n      if (initialized) return set(Promise.reject(error));\n\n      initialized = true;\n      reject(error);\n    }\n  };\n}\n","import { readable } from 'svelte/store';\nimport { isObservable, deferred } from './utils';\nimport { Observable, ReadableStore, Deferred } from './types';\n\nconst noop = () => {};\n\nexport default function observe<T>(\n  observable: any,\n  initial?: T\n): ReadableStore<Deferred<T>> {\n  if (!isObservable(observable)) {\n    return readable(observable as T, noop);\n  }\n\n  return readable((undefined as unknown) as Deferred<T>, set => {\n    const { fulfill, reject } = deferred<T>(set, initial);\n\n    const subscription = (observable as Observable<T>).subscribe({\n      next(value) {\n        fulfill(value);\n      },\n      error(err) {\n        reject(err);\n      }\n    });\n\n    return () => subscription.unsubscribe();\n  });\n}\n","import { readable } from 'svelte/store';\nimport { isObservable, deferred } from './utils';\nimport observe from './observe';\nimport {\n  ReadableStore,\n  Unsubscribe,\n  Observable,\n  Fulfill,\n  Reject,\n  Deferred\n} from './types';\n\ntype Store<T> = ReadableStore<T> & object;\ntype Subscribable<T> = Observable<T> | Store<T>;\ntype Any<T> = T | Observable<T> | Store<T>;\n\nexport default function flat<T>(\n  subscribable: Subscribable<Any<T>>,\n  initial?: T\n): ReadableStore<Deferred<T>> {\n  const is_observable = isObservable(subscribable);\n\n  return readable((undefined as unknown) as Deferred<T>, set => {\n    let inner_unsubscribe: Unsubscribe | null = null;\n    let outer_unsubscribe: Unsubscribe | null = null;\n\n    const { fulfill = (value: T) => set(value), reject } = (is_observable\n      ? deferred<T>(set, initial)\n      : {}) as { fulfill?: Fulfill<T>; reject?: Reject };\n\n    function next(value: Any<T>) {\n      if (inner_unsubscribe) {\n        inner_unsubscribe();\n        inner_unsubscribe = null;\n      }\n      if (isObservable(value))\n        value = observe(value as Observable<T>) as Store<T>;\n\n      if (isStore(value)) {\n        inner_unsubscribe = value.subscribe(inner => fulfill(inner));\n      } else {\n        fulfill(value as T);\n      }\n    }\n    function error(error: Error) {\n      reject!(error);\n    }\n\n    if (is_observable) {\n      const subscription = (subscribable as Observable<Any<T>>).subscribe({\n        next,\n        error\n      });\n      outer_unsubscribe = () => subscription.unsubscribe();\n    } else {\n      outer_unsubscribe = (subscribable as Store<Any<T>>).subscribe(next);\n    }\n\n    return () => {\n      if (inner_unsubscribe) inner_unsubscribe();\n      outer_unsubscribe!();\n    };\n  });\n}\n\nfunction isStore(value: any): value is Store<any> {\n  return value && typeof value.subscribe === 'function';\n}\n"],"names":["readable"],"mappings":"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"}